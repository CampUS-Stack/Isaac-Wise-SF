<!--
 - Created by Chris Home Desktop on 8/9/2017.
 -->

<apex:page id="ManageParticipants" extensions="ManageParticipantsController" standardController="Event__c">

    <apex:includeScript value="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js" />
    <apex:form id="theForm">
        <apex:actionFunction reRender="theForm" name="rerenderForm" />
        <apex:pageBlock title="Add Event Participants" id="classPageBlock">
            <apex:pageBlockButtons location="top">
                <apex:commandButton action="{!ShowAddParticipantSection}" reRender="rosterDisplayArea" value="Search for Participant"/>
                <!--<apex:commandButton action="/apex/ClassRoster_Copy?id={!$CurrentPage.parameters.id}&retURl={!$CurrentPage.URL}" value="Copy Another Class Roster"/>-->
                <apex:commandButton action="/{!TheEvent.Id}" reRender="rosterDisplayArea" value="Back to Event"/>
            </apex:pageBlockButtons>
            <apex:pageBlockSection columns="2">
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="Event Name" for="eventName" />
                    <apex:outputField id="eventName" value="{!TheEvent.Name}" />
                </apex:pageBlockSectionItem>
            </apex:pageBlockSection>
        </apex:pageBlock>
        <apex:outputPanel id="rosterDisplayArea">
            <apex:outputPanel rendered="{!displayAddContact}">
                <table width="100%">
                    <col width="65%"/>
                    <col width="35%"/>
                    <tr>
                        <td style="vertical-align:top;">
                            <apex:pageBlock id="theBlock" >
                                <apex:pageBlockButtons location="top">
                                    <apex:commandButton id="addStudentSearchBtn" value="Search" action="{!RunContactSearches}" reRender="theBlock,theBlock2"/>
                                    <!--<apex:commandButton value="Clear" onclick="window.location.reload();" reRender="theBlock,theBlock2"/>-->
                                    <apex:commandButton value="Clear" action="{!ClearAddParticipantForm}" reRender="theBlock,theBlock2"/>
                                    <apex:commandButton value="View Participants" action="{!UnShowAddParticipantSection}" />
                                </apex:pageBlockButtons>
                                <apex:pageBlockSection columns="2">
                                    <apex:pageBlockSectionItem >
                                        <apex:outputLabel value="Participant Name" for="participantName" />
                                        <apex:inputText id="participantName" value="{!ContactNameToSearch}" onKeyPress="checkForEnterKey(event);"/>
                                    </apex:pageBlockSectionItem>
                                    <apex:pageBlockSectionItem >
                                        <apex:outputLabel value="Program" for="program" />
                                        <apex:inputField id="program" value="{!DummyEvent.Parent_Program__c}" onKeyPress="checkForEnterKey(event);"/>
                                    </apex:pageBlockSectionItem>
                                    <!--<apex:pageBlockSectionItem >-->
                                    <!--<apex:outputLabel value="School Year" for="className" />-->
                                    <!--<apex:inputField id="studentName" value="{!theClass.Name}" onKeyPress="checkForEnterKey(event);"/>-->
                                    <!--</apex:pageBlockSectionItem>-->
                                </apex:pageBlockSection>
                                <apex:pageBlockSection title="Contacts" columns="1">
                                    <apex:pageBlockSectionItem >
                                        <apex:outputLabel value=""  />
                                        <apex:commandButton onclick="var r = confirm('Are you sure you want to enroll all the participants in {!JSINHTMLENCODE(TheEvent.Name)}?'); if(r == false){return false}" id="addStudentBtn" value="Add Participants" action="{!AddSelectedContacts}" reRender="theBlock,theBlock2"/>
                                    </apex:pageBlockSectionItem>
                                    <apex:pageBlockTable width="100%" value="{!TheContacts}" var="contactwrap">
                                        <apex:column >
                                            <apex:facet name="header">
                                                <!--<apex:commandLink value="Select All"   action="{!SelectAllStudents}"  reRender="theBlock,theBlock2"/>-->
                                            </apex:facet>
                                            <apex:inputCheckbox styleClass="studentCheckbox" value="{!contactwrap.isSelected}"/>
                                        </apex:column>
                                        <apex:column value="{!contactwrap.theContact.FirstName}" >
                                            <apex:facet name="header">
                                                <apex:commandLink style="color:black;" action="{!changeSortColumn}" value="First Name   {!IF(selectedField=='FirstName',IF(selectedSortOrder=='DESC','▼','▲'),'')}">
                                                    <apex:param value="FirstName" name="column" assignTo="{!selectedField}" ></apex:param>
                                                </apex:commandLink>
                                            </apex:facet>
                                        </apex:column>
                                        <apex:column value="{!contactwrap.theContact.LastName}" >
                                            <apex:facet name="header">
                                                <apex:commandLink style="color:black;" action="{!changeSortColumn}" value="Last Name   {!IF(selectedField=='LastName',IF(selectedSortOrder=='DESC','▼','▲'),'')}">
                                                    <apex:param value="LastName" name="column" assignTo="{!selectedField}" ></apex:param>
                                                </apex:commandLink>
                                            </apex:facet>
                                        </apex:column>
                                        <apex:column value="{!contactwrap.theContact.Account.Name}" >
                                        </apex:column>
                                        <apex:column value="{!contactwrap.theContact.Contact_Type__c}" >
                                            <apex:facet name="header">
                                                <apex:commandLink style="color:black;" action="{!changeSortColumn}" value="Contact Type   {!IF(selectedField=='Contact_Type__c',IF(selectedSortOrder=='DESC','▼','▲'),'')}">
                                                    <apex:param value="Contact_Type__c" name="column" assignTo="{!selectedField}" ></apex:param>
                                                </apex:commandLink>
                                            </apex:facet>
                                        </apex:column>
                                    </apex:pageBlockTable>
                                </apex:pageBlockSection>
                            </apex:pageBlock>
                        </td>
                        <td style="vertical-align:top;">
                            <apex:pageBlock id="theBlock2" >
                                <apex:pageBlockSection title="Participants" columns="1">
                                    <apex:pageBlockTable width="100%"  value="{!AttendingContacts}" var="contactwrap">
                                        <!--<apex:column width="6%" headerValue="Action">-->
                                        <!--<apex:commandButton value="Remove" action="{!RemoveStudent}" reRender="theBlock,theBlock2" onComplete="classPageBlock">-->
                                        <!--<apex:param name="theParam" assignTo="{!StudentIdToRemove}" value="{!studentwrap.student.Id}" />-->
                                        <!--</apex:commandButton>-->
                                        <!--</apex:column>-->
                                        <apex:column value="{!contactwrap.theContact.FirstName}" />
                                        <apex:column value="{!contactwrap.theContact.LastName}" />
                                        <apex:column value="{!contactwrap.theContact.Account.Name}" />
                                        <apex:column value="{!contactwrap.theContact.Contact_Type__c}" />
                                    </apex:pageBlockTable>
                                </apex:pageBlockSection>
                            </apex:pageBlock>
                        </td>
                    </tr>
                </table>
            </apex:outputPanel>
            <apex:outputPanel rendered="{!NOT(displayAddContact)}">
                <apex:pageBlock id="maincurrentEnrolledBlock">
                    <apex:pageBlockSection title="Current Participants" columns="1">
                        <apex:outputPanel >
                            <apex:commandButton onclick="var r = confirm('Are you sure you want to mark all the selected participants as attending {!TheEvent.Name}?'); if(r == false){return false}" id="rsvp" value="Attendance" action="{!MarkParticipantsAsAttending}"/>&nbsp;&nbsp;&nbsp;&nbsp;
                            <apex:commandButton onclick="var r = confirm('Are you sure you want to REMOVE all the selected participants from {!TheEvent.Name}?'); if(r == false){return false}" id="addStudentBtn" value="Remove" action="{!RemoveParticipant}"/>
                        </apex:outputPanel>
                        <apex:pageBlockTable width="100%" value="{!AttendingContacts}" var="contactwrap">
                            <apex:column width="15%" headerValue="Action">
                                <apex:facet name="header">

                                    <apex:inputCheckbox onClick="toggle(this)"></apex:inputCheckbox>
                                    <!--<apex:commandLink value="Remove" onclick="var r = confirm('Are you sure you want to remove {!contactwrap.theContact.Name} from {!TheEvent.Name}?'); if(r == false){return false}" action="{!RemoveParticipant}"  reRender="maincurrentEnrolledBlock">-->
                                    <!--<apex:param name="theParam" assignTo="{!ContactIdToRemove}" value="{!contactwrap.theContact.Id}" />-->
                                    <!--</apex:commandLink>&nbsp;|&nbsp;-->
                                    <!--<apex:commandLink value="RSVP" onclick="var r = confirm('Are you sure you want to remove {!contactwrap.theContact.Name} from {!TheEvent.Name}?'); if(r == false){return false}" action="{!RemoveParticipant}"  reRender="maincurrentEnrolledBlock">-->
                                    <!--<apex:param name="theParam" assignTo="{!ContactIdToRemove}" value="{!contactwrap.theContact.Id}" />-->
                                    <!--</apex:commandLink>-->
                                </apex:facet>
                                <apex:inputCheckbox styleClass="studentCheckbox prtiCheckbox" value="{!contactwrap.isSelected}"/>
                            </apex:column>
                            <apex:column value="{!contactwrap.theContact.FirstName}" />
                            <apex:column value="{!contactwrap.theContact.LastName}" />
                            <apex:column headerValue="Attended" >
                                <apex:outputField value="{!contactwrap.participant.Attended__c}" />
                            </apex:column>
                            <apex:column value="{!contactwrap.theContact.Account.Name}" />
                            <apex:column value="{!contactwrap.theContact.Contact_Type__c}" />
                        </apex:pageBlockTable>
                    </apex:pageBlockSection>
                </apex:pageBlock>
            </apex:outputPanel>
        </apex:outputPanel>
        <apex:actionFunction name="reRenderDisplayArea" reRender="rosterDisplayArea,theBlock,theBlock2" />
        <script>

            $j = jQuery.noConflict();

            $j(document).ready(function() {

            });

            function checkForEnterKey(e){
                console.log('Click found. ' + e.keyCode + ' ' + e.ctrlKey);
                if (e.keyCode==13){
                    e.preventDefault();
                    console.log('Enter Key found.');
                    $j('[id$=addStudentSearchBtn]').trigger('click');
                }
            }

            function toggle(source) {
                checkboxes = $j('.prtiCheckbox');
                for(var i=0, n=checkboxes.length;i<n;i++) {
                    checkboxes[i].checked = source.checked;
                }
            }

        </script>
    </apex:form>
</apex:page>